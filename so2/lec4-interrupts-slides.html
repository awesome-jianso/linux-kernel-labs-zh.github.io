<!DOCTYPE html>


<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SO2 Lecture 04 - Interrupts &mdash; Linux 系统内核  documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/styles.css" type="text/css" />
    <link rel="stylesheet" href="../_static/single.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    
    
    <link rel="stylesheet" href="../_static/asciinema-player.css" type="text/css" />
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/asciinema-player.js"></script>
    <script type="text/javascript" src="../_static/common.js"></script>
    
    <script type="text/javascript" src="../_static/slides.js"></script>
    <script type="text/javascript" src="../_static/sync.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>
    
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Linux 系统内核  documentation" href="../index.html" />
    <link rel="up" title="Operating Systems 2" href="index.html" />
    <link rel="next" title="SO2 Lecture 05 - Symmetric Multi-Processing" href="lec5-smp.html" />
    <link rel="prev" title="SO2 Lecture 03 - Processes" href="lec3-processes.html" /> 
  </head>
  <body>

<section
   id="slide_container"
   class='slides layout-regular'>


  
<article class="admonition-so2-lecture-04-interrupts slide level-1">

<h1>SO2 Lecture 04 - Interrupts</h1>





</article>
<article class="admonition-interrupts slide level-2">

<h2>Interrupts</h2>

<ul class="simple">
<li>Interrupts and exceptions (x86)</li>
<li>Interrupts and exceptions (Linux)</li>
<li>Deferrable work</li>
<li>Timers</li>
</ul>




</article>
<article class="admonition-interrupts slide level-2">

<h2>Interrupts</h2>

<ul class="simple">
<li><strong>synchronous</strong>, generated by executing an instruction</li>
<li><strong>asynchronous</strong>, generated by an external event</li>
<li><strong>maskable</strong><ul>
<li>can be ignored</li>
<li>signaled via INT pin</li>
</ul>
</li>
<li><strong>non-maskable</strong><ul>
<li>cannot be ignored</li>
<li>signaled via NMI pin</li>
</ul>
</li>
</ul>




</article>
<article class="admonition-exceptions slide level-2">

<h2>Exceptions</h2>

<ul class="simple">
<li>processor detected<ul>
<li><strong>faults</strong></li>
<li><strong>traps</strong></li>
<li><strong>aborts</strong></li>
</ul>
</li>
<li>programmed<ul>
<li><strong>int n</strong></li>
</ul>
</li>
</ul>




</article>
<article class="admonition-quiz-interrupt-terminology slide level-2">

<h2>Quiz: interrupt terminology</h2>

<p>For each of the following terms on the left select all the terms
from right that best describe them.</p>
<table class="hlist"><tr><td><ul class="simple">
<li>Watchdog</li>
<li>Demand paging</li>
<li>Division by zero</li>
<li>Timer</li>
<li>System call</li>
<li>Breakpoint</li>
</ul>
</td><td><ul class="simple">
<li>Exception</li>
<li>Interrupt</li>
<li>Maskable</li>
<li>Nonmaskable</li>
<li>Trap</li>
<li>Fault</li>
</ul>
</td></tr></table>




</article>
<article class="admonition-programmable-interrupt-controller slide level-2">

<h2>Programmable Interrupt Controller</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-5db1739b80a83b12505e4ff749b5e69fccd01f1b.png" src="../_images/ditaa-5db1739b80a83b12505e4ff749b5e69fccd01f1b.png" />




</article>
<article class="admonition-interrupt-controllers-in-smp-systems slide level-2">

<h2>Interrupt controllers in SMP systems</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-9d23d02ebdff6eeb6bec8044480f055de9852ecc.png" src="../_images/ditaa-9d23d02ebdff6eeb6bec8044480f055de9852ecc.png" />




</article>
<article class="admonition-enabling-disabling-the-interrupts slide level-2">

<h2>Enabling/disabling the interrupts</h2>

<ul class="simple">
<li>at the device level<ul>
<li>by programming the device control registers</li>
</ul>
</li>
<li>at the PIC level<ul>
<li>PIC can be programmed to disable a given IRQ line</li>
</ul>
</li>
<li>at the CPU level; for example, on x86 one can use the following
instructions:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>cli (CLear Interrupt flag)</li>
<li>sti (SeT Interrupt flag)</li>
</ul>
</div></blockquote>




</article>
<article class="admonition-interrupt-priorities slide level-2">

<h2>Interrupt priorities</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-8b00a68b494f72d54b5fad38c88f7265aadaaa0e.png" src="../_images/ditaa-8b00a68b494f72d54b5fad38c88f7265aadaaa0e.png" />




</article>
<article class="admonition-quiz-hardware-concepts slide level-2">

<h2>Quiz: hardware concepts</h2>

<p>Which of the following statements are true?</p>
<ul class="simple">
<li>The CPU can start processing a new interrupt before the current
one is finished</li>
<li>Interrupts can be disabled at the device level</li>
<li>Lower priority interrupts can not preempt handlers for higher
priority interrupts</li>
<li>Interrupts can be disabled at the interrupt controller level</li>
<li>On SMP systems the same interrupt can be routed to different CPUs</li>
<li>Interrupts can be disabled at the CPU level</li>
</ul>




</article>
<article class="admonition-interrupt-descriptor-table slide level-2">

<h2>Interrupt Descriptor Table</h2>

<ul class="simple">
<li>it is used as a jump table by the CPU when a given vector is triggered</li>
<li>it is an array of 256 x 8 bytes entries</li>
<li>may reside anywhere in physical memory</li>
<li>processor locates IDT by the means of IDTR</li>
</ul>




</article>
<article class="admonition-linux-irq-vector-layout slide level-2">

<h2>Linux IRQ vector layout</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-5b3c93f6e612d0cc0e4d4837d92a443627405262.png" src="../_images/ditaa-5b3c93f6e612d0cc0e4d4837d92a443627405262.png" />




</article>
<article class="admonition-interrupt-descriptor-table-entry-gate slide level-2">

<h2>Interrupt descriptor table entry (gate)</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-eff5e0e3b58ce239d5310b22b89c0927be5853bd.png" src="../_images/ditaa-eff5e0e3b58ce239d5310b22b89c0927be5853bd.png" />




</article>
<article class="admonition-interrupt-handler-address slide level-2">

<h2>Interrupt handler address</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-b2023fce22479e20bbe08fd76eed87e9a0527688.png" src="../_images/ditaa-b2023fce22479e20bbe08fd76eed87e9a0527688.png" />




</article>
<article class="admonition-interrupt-handler-stack slide level-2">

<h2>Interrupt handler stack</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-85b69602726fa6143fc3ba0ffdb492454864aacf.png" src="../_images/ditaa-85b69602726fa6143fc3ba0ffdb492454864aacf.png" />




</article>
<article class="admonition-handling-an-interrupt-request slide level-2">

<h2>Handling an interrupt request</h2>

<ul>
<li><p class="first">CPU checks the current privilege level</p>
</li>
<li><p class="first">if need to change privilege level</p>
<blockquote>
<div><ul class="simple">
<li>change stack with the one associated with new privilege</li>
<li>save old stack information on the new stack</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">save EFLAGS, CS, EIP on stack</p>
</li>
<li><p class="first">save error code on stack in case of an abort</p>
</li>
<li><p class="first">execute the kernel interrupt handler</p>
</li>
</ul>




</article>
<article class="admonition-returning-from-an-interrupt slide level-2">

<h2>Returning from an interrupt</h2>

<ul class="simple">
<li>pop the error code (in case of an abort)</li>
<li>call IRET<ul>
<li>pops values from the stack and restore the following register: CS, EIP, EFLAGS</li>
<li>if privilege level changed returns to the old stack and old privilege level</li>
</ul>
</li>
</ul>




</article>
<article class="admonition-inspecting-the-x86-interrupt-handling slide level-2">

<h2>Inspecting the x86 interrupt handling</h2>

<p>&nbsp;</p>
<asciinema-player src="../_images/intr_x86.cast"></asciinema-player>



</article>
<article class="admonition-quiz-x86-interrupt-handling slide level-2">

<h2>Quiz: x86 interrupt handling</h2>

<p>The following gdb commands are used to determine the handler for
the int80 based system call exception. Select and arrange the
commands or output of the commands in the correct order.</p>
<div class="highlight-gdb"><div class="highlight"><pre><span></span>(void *) 0xc15de780 &lt;entry_SYSENTER_32&gt;

set $idtr_addr=($idtr_entry&gt;&gt;48&lt;&lt;16)|($idtr_entry&amp;0xffff)

print (void*)$idtr_addr

set $idtr = 0xff800000

(void *) 0xc15de874 &lt;entry_INT80_32&gt;

set $idtr = 0xff801000

set $idtr_entry = *(uint64_t*)($idtr + 8 * 128)

monitor info registers
</pre></div>
</div>




</article>
<article class="admonition-interrupt-handling-in-linux slide level-2">

<h2>Interrupt handling in Linux</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-da31e3d17a4d55e5c3dbc0bd5903306418a896ca.png" src="../_images/ditaa-da31e3d17a4d55e5c3dbc0bd5903306418a896ca.png" />




</article>
<article class="admonition-irq-and-exception-nesting-in-linux slide level-2">

<h2>IRQ and exception nesting in Linux</h2>

<ul class="simple">
<li>an exception (e.g. page fault, system call) can not preempt an interrupt;
if that occurs it is considered a bug</li>
<li>an interrupt can preempt an exception</li>
<li>an interrupt can not preempt another interrupt (it used to be possible)</li>
</ul>




</article>
<article class="admonition-interrupt-exception-nesting slide level-2">

<h2>Interrupt/Exception nesting</h2>

<p>&nbsp;</p>
<img alt="../_images/ditaa-2e49ca6ac606dab4b2b53231cfbe85ff06312d36.png" src="../_images/ditaa-2e49ca6ac606dab4b2b53231cfbe85ff06312d36.png" />




</article>
<article class="admonition-interrupt-context slide level-2">

<h2>Interrupt context</h2>

<blockquote>
<div><ul class="simple">
<li>it runs as a result of an IRQ (not of an exception)</li>
<li>there is no well defined process context associated</li>
<li>not allowed to trigger a context switch (no sleep, schedule, or user memory access)</li>
</ul>
</div></blockquote>




</article>
<article class="admonition-deferrable-actions slide level-2">

<h2>Deferrable actions</h2>

<blockquote>
<div><ul class="simple">
<li>Schedule callback functions to run at a later time</li>
<li>Interrupt context deferrable actions</li>
<li>Process context deferrable actions</li>
<li>APIs for initialization, scheduling, and masking</li>
</ul>
</div></blockquote>




</article>
<article class="admonition-soft-irqs slide level-2">

<h2>Soft IRQs</h2>

<blockquote>
<div><p>Soft IRQ APIs:</p>
<blockquote>
<div><ul class="simple">
<li>initialize: <code class="xref c c-func docutils literal"><span class="pre">open_softirq()</span></code></li>
<li>activation: <code class="xref c c-func docutils literal"><span class="pre">raise_softirq()</span></code></li>
<li>masking: <code class="xref c c-func docutils literal"><span class="pre">local_bh_disable()</span></code>, <code class="xref c c-func docutils literal"><span class="pre">local_bh_enable()</span></code></li>
</ul>
</div></blockquote>
<p>Once activated, the callback function <code class="xref c c-func docutils literal"><span class="pre">do_softirq()</span></code> runs either:</p>
<blockquote>
<div><ul class="simple">
<li>after an interrupt handler or</li>
<li>from the ksoftirqd kernel thread</li>
</ul>
</div></blockquote>
</div></blockquote>




</article>
<article class="admonition-ksoftirqd slide level-2">

<h2>ksoftirqd</h2>

<blockquote>
<div><ul class="simple">
<li>minimum priority kernel thread</li>
<li>runs softirqs after certain limits are reached</li>
<li>tries to achieve good latency and avoid process starvation</li>
</ul>
</div></blockquote>




</article>
<article class="admonition-types-of-soft-irqs slide level-2">

<h2>Types of soft IRQs</h2>

<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* PLEASE, avoid to allocate new softirqs, if you need not _really_ high</span>
<span class="cm">   frequency threaded job scheduling. For almost all the purposes</span>
<span class="cm">   tasklets are more than enough. F.e. all serial device BHs et</span>
<span class="cm">   al. should be converted to tasklets, not to softirqs.</span>
<span class="cm">*/</span>

<span class="k">enum</span>
<span class="p">{</span>
  <span class="n">HI_SOFTIRQ</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">TIMER_SOFTIRQ</span><span class="p">,</span>
  <span class="n">NET_TX_SOFTIRQ</span><span class="p">,</span>
  <span class="n">NET_RX_SOFTIRQ</span><span class="p">,</span>
  <span class="n">BLOCK_SOFTIRQ</span><span class="p">,</span>
  <span class="n">IRQ_POLL_SOFTIRQ</span><span class="p">,</span>
  <span class="n">TASKLET_SOFTIRQ</span><span class="p">,</span>
  <span class="n">SCHED_SOFTIRQ</span><span class="p">,</span>
  <span class="n">HRTIMER_SOFTIRQ</span><span class="p">,</span>
  <span class="n">RCU_SOFTIRQ</span><span class="p">,</span>    <span class="cm">/* Preferable RCU should always be the last softirq */</span>

  <span class="n">NR_SOFTIRQS</span>
<span class="p">};</span>
</pre></div>
</div>




</article>
<article class="admonition-packet-flood-example slide level-2">

<h2>Packet flood example</h2>

<p>&nbsp;</p>
<asciinema-player src="../_images/ksoftirqd-packet-flood.cast"></asciinema-player>



</article>
<article class="admonition-tasklets slide level-2">

<h2>Tasklets</h2>

<p>Tasklets are a dynamic type (not limited to a fixed number) of
deferred work running in interrupt context.</p>
<p>Tasklets API:</p>
<blockquote>
<div><ul class="simple">
<li>initialization: <code class="xref c c-func docutils literal"><span class="pre">tasklet_init()</span></code></li>
<li>activation: <code class="xref c c-func docutils literal"><span class="pre">tasklet_schedule()</span></code></li>
<li>masking: <code class="xref c c-func docutils literal"><span class="pre">tasklet_disable()</span></code>, <code class="xref c c-func docutils literal"><span class="pre">tasklet_enable()</span></code></li>
</ul>
</div></blockquote>
<p>Tasklets are implemented on top of two dedicated softirqs:
<code class="xref c c-macro docutils literal"><span class="pre">TASKLET_SOFITIRQ</span></code> and <code class="xref c c-macro docutils literal"><span class="pre">HI_SOFTIRQ</span></code></p>
<p>Tasklets are also serialized, i.e. the same tasklet can only execute on one processor.</p>




</article>
<article class="admonition-workqueues slide level-2">

<h2>Workqueues</h2>

<p>Workqueues are a type of deferred work that runs in process context.</p>
<p>They are implemented on top of kernel threads.</p>
<p>Workqueues API:</p>
<blockquote>
<div><ul class="simple">
<li>init: <code class="xref c c-macro docutils literal"><span class="pre">INIT_WORK</span></code></li>
<li>activation: <code class="xref c c-func docutils literal"><span class="pre">schedule_work()</span></code></li>
</ul>
</div></blockquote>




</article>
<article class="admonition-timers slide level-2">

<h2>Timers</h2>

<blockquote>
<div><p>Timers are implemented on top of the <code class="xref c c-macro docutils literal"><span class="pre">TIMER_SOFTIRQ</span></code></p>
<p>Timer API:</p>
<ul class="simple">
<li>initialization: <code class="xref c c-func docutils literal"><span class="pre">setup_timer()</span></code></li>
<li>activation: <code class="xref c c-func docutils literal"><span class="pre">mod_timer()</span></code></li>
</ul>
</div></blockquote>




</article>
<article class="admonition-deferrable-actions-summary slide level-2">

<h2>Deferrable actions summary</h2>

<blockquote>
<div><ul class="simple">
<li>softIRQ<ul>
<li>runs in interrupt context</li>
<li>statically allocated</li>
<li>same handler may run in parallel on multiple cores</li>
</ul>
</li>
<li>tasklet<ul>
<li>runs in interrupt context</li>
<li>can be dynamically allocated</li>
<li>same handler runs are serialized</li>
</ul>
</li>
<li>workqueues<ul>
<li>run in process context</li>
</ul>
</li>
</ul>
</div></blockquote>




</article>
<article class="admonition-quiz-linux-interrupt-handling slide level-2">

<h2>Quiz: Linux interrupt handling</h2>

<p>Which of the following phases of interrupt handling runs with
interrupts disabled at the CPU level?</p>
<ul class="simple">
<li>Critical</li>
<li>Immediate</li>
<li>Deferred</li>
</ul>




</article>

</section>

<section id="slide_notes">

</section>

  </body>
</html>