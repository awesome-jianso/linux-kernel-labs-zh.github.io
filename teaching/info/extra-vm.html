<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customizing the Virtual Machine Setup &mdash; The Linux Kernel  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/asciinema-player.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
      <script>
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/asciinema-player.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing to linux-kernel-labs" href="contributing.html" />
    <link rel="prev" title="Virtual Machine Setup" href="vm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            The Linux Kernel
          </a>
              <div class="version">
                5.10.14
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../so2/index.html">Operating Systems 2</a></li>
</ul>
<p class="caption"><span class="caption-text">Lectures</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lectures/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/syscalls.html">System Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/interrupts.html">Interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/smp.html">Symmetric Multi-Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/address-space.html">Address Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/memory-management.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/fs.html">Filesystem Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/networking.html">Network Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/arch.html">Architecture Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lectures/virt.html">Virtualization</a></li>
</ul>
<p class="caption"><span class="caption-text">Labs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../labs/infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/kernel_modules.html">Kernel modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/kernel_api.html">Kernel API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/device_drivers.html">Character device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/interrupts.html">I/O access and Interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/deferred_work.html">Deferred work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/block_device_drivers.html">Block Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/filesystems_part1.html">File system drivers (Part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/filesystems_part2.html">File system drivers (Part 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/arm_kernel_development.html">Kernel Development on ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/memory_mapping.html">Memory mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/device_model.html">Linux Device Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/kernel_profiling.html">Kernel Profiling</a></li>
</ul>
<p class="caption"><span class="caption-text">Useful info</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="vm.html">Virtual Machine Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customizing the Virtual Machine Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#connect-to-the-virtual-machine-via-ssh">Connect to the Virtual Machine via SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-a-debugger-to-the-virtual-machine-kernel">Connecting a Debugger to the Virtual Machine Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rebuild-the-kernel-image">Rebuild the Kernel Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-docker-containers">Using Docker containers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to linux-kernel-labs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Customizing the Virtual Machine Setup</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/info/extra-vm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="customizing-the-virtual-machine-setup">
<h1>Customizing the Virtual Machine Setup<a class="headerlink" href="#customizing-the-virtual-machine-setup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="connect-to-the-virtual-machine-via-ssh">
<h2>Connect to the Virtual Machine via SSH<a class="headerlink" href="#connect-to-the-virtual-machine-via-ssh" title="Permalink to this headline">¶</a></h2>
<p>The default Yocto image for the QEMU virtual machine
(<code class="docutils literal"><span class="pre">core-image-minimal-qemu</span></code>) provides the minimal functionality to run the
kernel and kernel modules. For extra features, such as an SSH connection,
a more complete image is required, such as <code class="docutils literal"><span class="pre">core-image-sato-dev-qemu</span></code>.</p>
<p>To use the new image, update the <code class="docutils literal"><span class="pre">YOCTO_IMAGE</span></code> variable in
<code class="docutils literal"><span class="pre">tools/labs/qemu/Makefile</span></code>:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">YOCTO_IMAGE</span> <span class="o">=</span> core-image-sato-qemu<span class="k">$(</span>ARCH<span class="k">)</span>.ext4
</pre></div>
</div>
<p>When you start the virtual machine the first time using <code class="docutils literal"><span class="pre">make</span> <span class="pre">boot</span></code> with the
new image configuration, it will download the image and then boot the virtual
machine. The image is larger (around 400MB) than the minimal image so expect
some time for the download.</p>
<p>You then enter the virtual machine via <code class="docutils literal"><span class="pre">minicom</span></code>, determine the IP address of
the <code class="docutils literal"><span class="pre">eth0</span></code> interface an then you can connect to the virtual machine via SSH:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>$ minicom -D serial.pts
Poky (Yocto Project Reference Distro) 2.3 qemux86 /dev/hvc0

qemux86 login: root
root@qemux86:~# ip a s
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast qlen 1000
    link/ether 52:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff
    inet 172.213.0.18/24 brd 172.213.0.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe12:3456/64 scope link
       valid_lft forever preferred_lft forever
3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0

$ ssh -l root 172.213.0.18
The authenticity of host &#39;172.213.0.18 (172.213.0.18)&#39; can&#39;t be established.
RSA key fingerprint is SHA256:JUWUcD7LdvURNcamoPePMhqEjFFtUNLAqO+TtzUiv5k.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;172.213.0.18&#39; (RSA) to the list of known hosts.
root@qemux86:~# uname -a
Linux qemux86 4.19.0+ #3 SMP Sat Apr 4 22:45:18 EEST 2020 i686 GNU/Linux
</pre></div>
</div>
</div>
<div class="section" id="connecting-a-debugger-to-the-virtual-machine-kernel">
<h2>Connecting a Debugger to the Virtual Machine Kernel<a class="headerlink" href="#connecting-a-debugger-to-the-virtual-machine-kernel" title="Permalink to this headline">¶</a></h2>
<p>You can use GDB to connect to the running virtual machine kernel and inspect
the state of the kernel. You run <code class="docutils literal"><span class="pre">make</span> <span class="pre">gdb</span></code> in <code class="docutils literal"><span class="pre">tools/labs/</span></code>:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>.../linux/tools/labs$ make gdb
ln -fs /home/tavi/src/linux/vmlinux vmlinux
gdb -ex <span class="s2">&quot;target remote localhost:1234&quot;</span> vmlinux
GNU gdb <span class="o">(</span>Ubuntu <span class="m">7</span>.11.1-0ubuntu1~16.04<span class="o">)</span> <span class="m">7</span>.11.1
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2016</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type <span class="s2">&quot;show copying&quot;</span>
and <span class="s2">&quot;show warranty&quot;</span> <span class="k">for</span> details.
This GDB was configured as <span class="s2">&quot;x86_64-linux-gnu&quot;</span>.
Type <span class="s2">&quot;show configuration&quot;</span> <span class="k">for</span> configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For help, <span class="nb">type</span> <span class="s2">&quot;help&quot;</span>.
Type <span class="s2">&quot;apropos word&quot;</span> to search <span class="k">for</span> commands related to <span class="s2">&quot;word&quot;</span>...
Reading symbols from vmlinux...done.
Remote debugging using localhost:1234
0xc13cf2f2 in native_safe_halt <span class="o">()</span> at ./arch/x86/include/asm/irqflags.h:53
53asm volatile<span class="o">(</span><span class="s2">&quot;sti; hlt&quot;</span>: : :<span class="s2">&quot;memory&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c1">#0  0xc13cf2f2 in native_safe_halt () at ./arch/x86/include/asm/irqflags.h:53</span>
<span class="c1">#1  arch_safe_halt () at ./arch/x86/include/asm/irqflags.h:95</span>
<span class="c1">#2  default_idle () at arch/x86/kernel/process.c:341</span>
<span class="c1">#3  0xc101f136 in arch_cpu_idle () at arch/x86/kernel/process.c:332</span>
<span class="c1">#4  0xc106a6dd in cpuidle_idle_call () at kernel/sched/idle.c:156</span>
<span class="c1">#5  do_idle () at kernel/sched/idle.c:245</span>
<span class="c1">#6  0xc106a8c5 in cpu_startup_entry (state=&lt;optimized out&gt;)</span>
at kernel/sched/idle.c:350
<span class="c1">#7  0xc13cb14a in rest_init () at init/main.c:415</span>
<span class="c1">#8  0xc1507a7a in start_kernel () at init/main.c:679</span>
<span class="c1">#9  0xc10001da in startup_32_smp () at arch/x86/kernel/head_32.S:368</span>
<span class="c1">#10 0x00000000 in ?? ()</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="rebuild-the-kernel-image">
<h2>Rebuild the Kernel Image<a class="headerlink" href="#rebuild-the-kernel-image" title="Permalink to this headline">¶</a></h2>
<p>The kernel image is built the first time the VM is started. To rebuild the
kernel remove the kernel image file defined by the <code class="docutils literal"><span class="pre">ZIMAGE</span></code> variable in
<code class="docutils literal"><span class="pre">tools/labs/qemu/Makefile</span></code>:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nv">ZIMAGE</span> <span class="o">=</span> <span class="k">$(</span>KDIR<span class="k">)</span>/arch/<span class="k">$(</span>ARCH<span class="k">)</span>/boot/<span class="k">$(</span>b<span class="k">)</span>zImage
</pre></div>
</div>
<p>Typically the full path of the kernel is <code class="docutils literal"><span class="pre">arch/x86/boot/bzImage</span></code>.</p>
<p>Once removed the kernel image is rebuild by using:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>~/src/linux/tools/labs$ make zImage
</pre></div>
</div>
<p>or simply starting the virtual machine</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>~/src/linux/tools/labs$ make boot
</pre></div>
</div>
</div>
<div class="section" id="using-docker-containers">
<h2>Using Docker containers<a class="headerlink" href="#using-docker-containers" title="Permalink to this headline">¶</a></h2>
<p>If your setup doesn't allow the installation of the packages required for the
laboratory setup, you can build and run a container that has all the setup
already prepared for the virtual machine environment.</p>
<p>In order to run the containerized setup, you need to install the following
packages:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">docker</span></code></li>
<li><code class="docutils literal"><span class="pre">docker-compose</span></code></li>
</ul>
<p>In order to run the container infrastructure run the following command in the
<code class="docutils literal"><span class="pre">tools/labs/</span></code> directory:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>sergiu@local:~/src/linux/tools/labs$ make docker-kernel
...
ubuntu@so2:~$
</pre></div>
</div>
<p>The first time you run the command above, it will take a long time, because you
will have to build the container environment and install the required
applications.</p>
<p>Every time you run the <code class="docutils literal"><span class="pre">make</span> <span class="pre">docker-kernel</span></code> command, another shell will
connect to the container. This will allow you to work with multiple tabs.</p>
<p>All the commands that you would use in the regular environment can be used in
the containerized environment.</p>
<p>The linux repository is mounted in the <code class="docutils literal"><span class="pre">/linux</span></code> directory. All changes
you will make here will also be seen on your local instance.</p>
<p>In order to stop the container use the following command:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>make stop-docker-kernel
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vm.html" class="btn btn-neutral float-left" title="Virtual Machine Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contributing.html" class="btn btn-neutral float-right" title="Contributing to linux-kernel-labs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The kernel development community.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>